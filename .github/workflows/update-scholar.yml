- name: Fetch Scholar data
run: |
  API_KEY="3900f54f31f2a51e27c2e1c879256310791bd0f35e83c6d2edaaaa790b97522b"
  AUTHOR_ID="pUSXwTMAAAAJ"
  URL="https://serpapi.com/search.json?engine=google_scholar_author&api_key=${API_KEY}&author_id=${AUTHOR_ID}&hl=en"
  RAW=$(curl -s "$URL")

  echo "🔍 SerpAPI raw author block:"  
  echo "$RAW" \
    | jq '.author // { warning: "no author key", full: . }' \
    || true

  # try both possible paths for citations and h‑index
  CITS=$(echo "$RAW" \
    | jq -r '(.author.cited_by.total // .cited_by.total) // empty')
  HIDX=$(echo "$RAW" \
    | jq -r '(.author.h_index.all   // .h_index)        // empty')
  TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

  if [[ -z "$CITS" || -z "$HIDX" ]]; then
    echo "❌ Could not parse metrics. Full raw JSON:"
    echo "$RAW" | head -n40
    exit 1
  fi

  cat > metrics.json <<EOF
  {
    "citations": $CITS,
    "h_index": $HIDX,
    "fetched_at": "$TIMESTAMP"
  }
  EOF
